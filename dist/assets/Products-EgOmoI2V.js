import{r as x,a as ge,c as he,j as e,P as V,f as v,E as ye,M as D,X as Z,s as j,V as g,C as je}from"./index-lSf8Or_v.js";import{o as pe}from"./eventBus-DPsVa6OD.js";import{c as fe}from"./store-user-helpers-N5knuo_n.js";import{P as H,S as be}from"./search-CjY5xoAW.js";import{P as Ne}from"./pen-square-p8pL3Dzn.js";import{T as _e}from"./trash-2-DpKFTnJj.js";import{S as J}from"./save-DqLXVkk1.js";const Ee=()=>{const[k,W]=x.useState(""),[F,ee]=x.useState("all"),[te,w]=x.useState(!1),[b,S]=x.useState(null),[d,T]=x.useState(null),[C,K]=x.useState(null),[se,q]=x.useState(!1),[A,P]=x.useState(""),[N,z]=x.useState(!1),{profile:s,loading:O}=ge(),[E,_]=x.useState([]),[R,M]=x.useState(!0),[L,B]=x.useState(null),[ae,G]=x.useState(["all"]),[I,$]=x.useState(new Map),[re,U]=x.useState([]);x.useEffect(()=>{let t=!0;const a=async()=>{try{M(!0),B(null);let i=(s==null?void 0:s.store_id)||null;if(!i&&(s!=null&&s.id)){const{data:l,error:y}=await j.from("store_users").select("store_id").eq("user_id",s.id).eq("is_active",!0).limit(1).maybeSingle();if(y&&y.code!=="PGRST116")throw y;l!=null&&l.store_id&&(i=l.store_id)}if(!i){t&&(_([]),G(["all"]),U([]));return}const{data:m,error:r}=await j.from("products").select("id, name, sku, barcode, description, cost_price, selling_price, stock_quantity, min_stock_level, image_url, category_id, created_at, updated_at").eq("store_id",i).order("updated_at",{ascending:!1});if(r)throw r;const{data:o,error:h}=await j.from("categories").select("id, name").eq("store_id",i).order("name");if(h)throw h;if(!t)return;_(m||[]);const c=new Map((o||[]).map(l=>[l.id,l.name]));if($(c),U(o||[]),G(["all",...Array.from(new Set((m||[]).map(l=>c.get(l.category_id)).filter(Boolean)))]),!(s!=null&&s.store_id)&&(s!=null&&s.id))try{await j.from("profiles").update({store_id:i,updated_at:new Date().toISOString()}).eq("id",s.id)}catch{}}catch(i){if(!t)return;console.error("Failed to load products:",i),B("Failed to load products")}finally{t&&M(!1)}};O?M(!0):a();const n=pe("transaction:completed",()=>a());return()=>{t=!1,n&&n()}},[O,s==null?void 0:s.store_id]);const{register:p,handleSubmit:le,reset:f,watch:Q,setValue:ie,getValues:ce,formState:{errors:u}}=he(),ne=(t="")=>{const a=(t||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]+/g,"").slice(0,6)||"SKU",n=Date.now().toString(36).toUpperCase().slice(-5);return`${a}-${n}`},Y=E.filter(t=>{const a=t.name.toLowerCase().includes(k.toLowerCase())||t.sku.toLowerCase().includes(k.toLowerCase())||(t.barcode||"").includes(k),n=I.get(t.category_id);return a&&(F==="all"||n===F)}),de=async t=>{try{let a=(s==null?void 0:s.store_id)||null;if(!a&&(s!=null&&s.id)){const{data:l,error:y}=await j.from("store_users").select("store_id").eq("user_id",s.id).eq("is_active",!0).limit(1).maybeSingle();if(y&&y.code!=="PGRST116")throw y;l!=null&&l.store_id&&(a=l.store_id)}if(!a){if(!(s!=null&&s.id)){g.error("You must be signed in");return}const l=(s.full_name||s.email||"My Store").toString().split("@")[0]+"'s Store",y=await fe(j,s.id,l,"owner");if(!y.success||!y.storeId){console.error("Auto-create store failed:",y.error||y.message),g.error("Could not create a store for your account");return}a=y.storeId}let n=(t.sku||"").trim();n||(n=ne(t.name));const{data:i,error:m}=await j.from("products").select("id").eq("store_id",a).eq("sku",n).maybeSingle();if(m&&m.code!=="PGRST116")throw m;if(i){g.error("SKU already exists in your store");return}const r={...t,sku:n,cost_price:parseFloat(t.cost_price),selling_price:parseFloat(t.selling_price),stock_quantity:parseInt(t.stock_quantity),min_stock_level:parseInt(t.min_stock_level),store_id:a},{data:o,error:h}=await j.from("products").insert([r]).select();if(h){if(h.code==="23505"){g.error("SKU already exists");return}throw h}const c=o==null?void 0:o[0];if(c&&r.stock_quantity>0)try{await j.from("inventory_logs").insert([{product_id:c.id,store_id:a,type:"stock_in",quantity_change:r.stock_quantity,previous_quantity:0,new_quantity:r.stock_quantity,reason:"initial_stock",notes:"Initial stock on product creation",created_by:s.id}])}catch(l){console.warn("Inventory log failed:",l)}_([...o||[],...E]),w(!1),f(),g.success("Product added successfully!")}catch(a){console.error(a),g.error("Failed to add product")}},oe=async t=>{try{const a=(t.sku||"").trim()||b.sku,n={...t,sku:a,cost_price:parseFloat(t.cost_price),selling_price:parseFloat(t.selling_price),stock_quantity:parseInt(t.stock_quantity),min_stock_level:parseInt(t.min_stock_level)},{data:i,error:m}=await j.from("products").update(n).eq("id",b.id).select();if(m)throw m;const r=E.map(o=>o.id===b.id?i[0]:o);_(r),S(null),f(),g.success("Product updated successfully!")}catch(a){console.error(a),g.error("Failed to update product")}},me=t=>{K(t)},xe=()=>{C!=null&&j.from("products").delete().eq("id",C).then(({error:t})=>{t?(console.error(t),g.error("Failed to delete product")):(_(E.filter(a=>a.id!==C)),g.success("Product deleted successfully!"))})},ue=t=>t.stock_quantity===0?{status:"out",color:"text-red-600",bg:"bg-red-100"}:t.stock_quantity<=t.min_stock_level?{status:"low",color:"text-orange-600",bg:"bg-orange-100"}:{status:"good",color:"text-green-600",bg:"bg-green-100"},X=({product:t,onSubmit:a,onCancel:n})=>{const i=parseFloat(Q("cost_price")||0),m=parseFloat(Q("selling_price")||0),r=Math.max(m-i,0),o=m>0?r/m*100:0,h=!!t;return e.jsxs("form",{onSubmit:le(a),className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Product Name *"}),e.jsx("input",{...p("name",{required:"Product name is required"}),className:"input",defaultValue:t==null?void 0:t.name,placeholder:"Enter product name"}),u.name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.name.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:["SKU ",h?"*":""]}),e.jsx("input",{...p("sku"),className:"input",defaultValue:t==null?void 0:t.sku,placeholder:h?"Enter SKU":"Leave blank to auto-generate"}),u.sku&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.sku.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Barcode"}),e.jsx("input",{...p("barcode"),className:"input",defaultValue:t==null?void 0:t.barcode,placeholder:"Enter barcode"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"label",children:"Category *"}),e.jsxs("button",{type:"button",onClick:()=>q(!0),className:"text-sm text-primary-600 hover:text-primary-500 inline-flex items-center",children:[e.jsx(H,{className:"w-3 h-3 mr-1"})," Add new"]})]}),e.jsxs("select",{...p("category_id",{required:"Category is required"}),className:"input",defaultValue:(t==null?void 0:t.category_id)||"",children:[e.jsx("option",{value:"",children:"Select category"}),re.map(c=>e.jsx("option",{value:c.id,children:c.name},c.id))]}),u.category_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.category_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Cost Price *"}),e.jsx("input",{type:"number",step:"0.01",...p("cost_price",{required:"Cost price is required",min:{value:0,message:"Cost price must be positive"}}),className:"input",defaultValue:t==null?void 0:t.cost_price,placeholder:"0.00"}),u.cost_price&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.cost_price.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Selling Price *"}),e.jsx("input",{type:"number",step:"0.01",...p("selling_price",{required:"Selling price is required",min:{value:0,message:"Selling price must be positive"},validate:c=>parseFloat(c||0)>=parseFloat(ce("cost_price")||0)||"Selling must be greater than or equal to cost"}),className:"input",defaultValue:t==null?void 0:t.selling_price,placeholder:"0.00"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Margin: ",v(r)," (",o.toFixed(1),"%)"]}),u.selling_price&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.selling_price.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Stock Quantity *"}),e.jsx("input",{type:"number",...p("stock_quantity",{required:"Stock quantity is required",min:{value:0,message:"Stock quantity must be positive"}}),className:"input",defaultValue:t==null?void 0:t.stock_quantity,placeholder:"0"}),u.stock_quantity&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.stock_quantity.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Minimum Stock Level"}),e.jsx("input",{type:"number",...p("min_stock_level",{min:{value:0,message:"Minimum stock must be positive"}}),className:"input",defaultValue:(t==null?void 0:t.min_stock_level)||0,placeholder:"0"}),u.min_stock_level&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.min_stock_level.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{...p("description"),className:"input h-24 resize-none",defaultValue:t==null?void 0:t.description,placeholder:"Enter product description"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e.jsxs("button",{type:"button",onClick:n,className:"btn btn-secondary btn-md",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",className:"btn btn-primary btn-md",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),h?"Update Product":"Add Product"]})]})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100",children:"Products"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-300",children:"Manage your product catalog and inventory"})]}),e.jsxs("button",{onClick:()=>w(!0),className:"btn btn-primary btn-md mt-4 sm:mt-0",children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Add Product"]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search products by name, SKU, or barcode...",value:k,onChange:t=>W(t.target.value),className:"input pl-10"})]}),e.jsx("select",{value:F,onChange:t=>ee(t.target.value),className:"input w-full sm:w-auto",children:ae.map(t=>e.jsx("option",{value:t,children:t==="all"?"All Categories":t},t))})]})}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"table-header",children:e.jsxs("tr",{children:[e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Product"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"SKU"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Category"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Price"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Stock"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:R?e.jsx("tr",{children:e.jsx("td",{className:"table-cell p-6",colSpan:"7",children:"Loading..."})}):L?e.jsx("tr",{children:e.jsx("td",{className:"table-cell p-6 text-red-600 dark:text-red-400",colSpan:"7",children:L})}):Y.map(t=>{const a=ue(t);return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mr-3",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx(V,{className:"w-5 h-5 text-gray-400 dark:text-gray-500"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs",children:t.description})]})]})}),e.jsx("td",{className:"table-cell",children:e.jsx("div",{className:"text-sm font-mono",children:t.sku})}),e.jsx("td",{className:"table-cell",children:e.jsx("span",{className:"badge badge-info",children:I.get(t.category_id)||"Uncategorized"})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:v(t.selling_price)}),e.jsxs("div",{className:"text-gray-500 dark:text-gray-400",children:["Cost: ",v(t.cost_price)]})]})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.stock_quantity}),e.jsxs("div",{className:"text-gray-500 dark:text-gray-400",children:["Min: ",t.min_stock_level]})]})}),e.jsx("td",{className:"table-cell",children:e.jsx("span",{className:`badge ${a.bg} ${a.color}`,children:a.status==="out"?"Out of Stock":a.status==="low"?"Low Stock":"In Stock"})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>T(t),className:"text-gray-400 dark:text-gray-500 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(ye,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{S(t),f(t)},className:"text-gray-400 dark:text-gray-500 hover:text-green-600 transition-colors",title:"Edit Product",children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>me(t.id),className:"text-gray-400 dark:text-gray-500 hover:text-red-600 transition-colors",title:"Delete Product",children:e.jsx(_e,{className:"w-4 h-4"})})]})})]},t.id)})})]})}),Y.length===0&&!R&&!L&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(V,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No products found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Try adjusting your search or add a new product"})]})]}),e.jsx(D,{isOpen:te,onClose:()=>{w(!1),f()},title:"Add New Product",size:"lg",children:e.jsx(X,{onSubmit:de,onCancel:()=>{w(!1),f()}})}),e.jsx(D,{isOpen:!!b,onClose:()=>{S(null),f()},title:"Edit Product",size:"lg",children:e.jsx(X,{product:b,onSubmit:oe,onCancel:()=>{S(null),f()}})}),e.jsx(D,{isOpen:!!d,onClose:()=>T(null),title:"Product Details",size:"md",children:d&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center",children:d.image_url?e.jsx("img",{src:d.image_url,alt:d.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx(V,{className:"w-8 h-8 text-gray-400 dark:text-gray-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:d.name}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:I.get(d.category_id)||"Uncategorized"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"SKU"}),e.jsx("p",{className:"font-mono",children:d.sku})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Barcode"}),e.jsx("p",{className:"font-mono",children:d.barcode||"N/A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Cost Price"}),e.jsx("p",{children:v(d.cost_price)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Selling Price"}),e.jsx("p",{className:"font-semibold",children:v(d.selling_price)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Stock Quantity"}),e.jsx("p",{children:d.stock_quantity})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Min Stock Level"}),e.jsx("p",{children:d.min_stock_level})]})]}),d.description&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Description"}),e.jsx("p",{className:"text-gray-900 dark:text-gray-100",children:d.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-500 dark:text-gray-400",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-medium",children:"Created"}),e.jsx("p",{children:new Date(d.created_at).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-medium",children:"Last Updated"}),e.jsx("p",{children:new Date(d.updated_at).toLocaleDateString()})]})]})]})}),e.jsx(D,{isOpen:se,onClose:()=>{N||(q(!1),P(""))},title:"Add New Category",size:"sm",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Category Name *"}),e.jsx("input",{type:"text",className:"input",value:A,onChange:t=>P(t.target.value),placeholder:"e.g. Beverages",autoFocus:!0,disabled:N})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-2",children:[e.jsxs("button",{type:"button",className:"btn btn-secondary btn-md",onClick:()=>{N||(q(!1),P(""))},disabled:N,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"button",className:"btn btn-primary btn-md",disabled:N||!A.trim(),onClick:async()=>{var a,n,i,m;const t=A.trim();if(t){z(!0);try{let r=(s==null?void 0:s.store_id)||null;if(!r&&(s!=null&&s.id)){const{data:c,error:l}=await j.from("store_users").select("store_id").eq("user_id",s.id).eq("is_active",!0).limit(1).maybeSingle();if(l&&l.code!=="PGRST116")throw l;c!=null&&c.store_id&&(r=c.store_id)}if(!r){g.error("No store found for your account");return}const{data:o,error:h}=await j.from("categories").insert([{name:t,store_id:r}]).select().single();if(h)throw h;U(c=>[...c,o]),$(c=>new Map(c).set(o.id,o.name)),ie("category_id",o.id),g.success("Category added"),q(!1),P("")}catch(r){console.error("Failed to add category:",r),(r==null?void 0:r.code)==="42501"||(n=(a=r==null?void 0:r.message)==null?void 0:a.toLowerCase)!=null&&n.call(a).includes("permission")||(m=(i=r==null?void 0:r.message)==null?void 0:i.toLowerCase)!=null&&m.call(i).includes("policy")?g.error("You do not have permission to add categories"):g.error("Failed to add category")}finally{z(!1)}}},children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Save"]})]})]})}),e.jsx(je,{isOpen:C!=null,onCancel:()=>K(null),onConfirm:xe,title:"Delete product?",description:"This action cannot be undone. The product will be removed from your catalog.",confirmText:"Delete",variant:"danger"})]})};export{Ee as default};
//# sourceMappingURL=Products-EgOmoI2V.js.map

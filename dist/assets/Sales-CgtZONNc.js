import{d as ie,a as oe,e as de,r as n,g as me,j as e,L as O,f as l,S as z,M as xe,C as Y,s as x,V as y}from"./index-BW0Fy5Jt.js";import{d as ue}from"./eventBus-DPsVa6OD.js";import{S as he,P as K}from"./search-CSlaLgzN.js";import{T as Q}from"./trash-2-COI-1Eqw.js";import{M as ge}from"./minus-HNRMu6oA.js";import{D as pe}from"./dollar-sign-M0xDBQVp.js";import{C as ye}from"./credit-card-BwB5o_4k.js";/**
 * @license lucide-react v0.307.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=ie("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]),_e=()=>{const{profile:h,user:g}=oe(),{add:U}=de(),[f,V]=n.useState(""),[k,B]=n.useState("all"),[X,j]=n.useState(!1),[i,w]=n.useState("cash"),[c,q]=n.useState(""),[C,T]=n.useState(!1),[G,_]=n.useState(!1),[S,b]=n.useState(null),{cart:d,totals:a,addItem:H,updateItem:J,removeItem:W,clearCart:A}=me(),[Z,D]=n.useState(!0),[I,F]=n.useState(null),[ee,te]=n.useState([]),[ae,se]=n.useState([]),[re,ne]=n.useState(new Map);n.useEffect(()=>{let t=!0;return(async()=>{try{D(!0),F(null);const{data:m,error:o}=await x.from("products").select("id, name, sku, barcode, selling_price, stock_quantity, image_url, category_id").order("name",{ascending:!0});if(o)throw o;const{data:N,error:v}=await x.from("categories").select("id, name").order("name",{ascending:!0});if(v)throw v;if(!t)return;te(m||[]);const p=new Map((N||[]).map(u=>[u.id,u.name]));ne(p);const r=Array.from(new Set((m||[]).map(u=>p.get(u.category_id)).filter(Boolean)));se(["all",...r])}catch(m){if(!t)return;console.error("Failed to load products/categories:",m),F("Failed to load products")}finally{t&&D(!1)}})(),()=>{t=!1}},[]);const M=ee.filter(t=>{const s=t.name.toLowerCase().includes(f.toLowerCase())||t.sku.toLowerCase().includes(f.toLowerCase())||(t.barcode||"").includes(f),m=re.get(t.category_id);return s&&(k==="all"||m===k)&&t.stock_quantity>0}),E=(t,s)=>{s<=0?b(t):J(t,{quantity:s})},le=async()=>{var t;if(d.items.length===0){y.error("Cart is empty");return}if(i==="cash"){const s=parseFloat(c);if(!s||s<a.total){y.error("Insufficient amount received");return}}T(!0);try{if(!(h!=null&&h.store_id)||!(g!=null&&g.id)){y.error("Missing store or user context");return}const s=new Date,m=`TX-${s.getFullYear()}${(s.getMonth()+1).toString().padStart(2,"0")}${s.getDate().toString().padStart(2,"0")}-${s.getTime().toString().slice(-6)}`,{data:o,error:N}=await x.from("transactions").insert([{transaction_number:m,store_id:h.store_id,customer_name:((t=d.customer)==null?void 0:t.name)||null,subtotal:a.subtotal,discount_percentage:a.discount,discount_amount:a.discountAmount,tax_rate:a.taxRate/100,tax_amount:a.taxAmount,total_amount:a.total,payment_method:i,amount_received:i==="cash"?parseFloat(c):a.total,change_amount:i==="cash"?Math.max(0,parseFloat(c)-a.total):0,status:"completed",processed_by:g.id,processed_at:s.toISOString()}]).select().single();if(N)throw N;const v=d.items.map(r=>({transaction_id:o.id,product_id:r.product_id,product_name:r.name,product_sku:r.sku,quantity:r.quantity,unit_price:r.price,total_price:r.price*r.quantity})),{error:p}=await x.from("transaction_items").insert(v);if(p)throw p;for(const r of d.items){const{data:u,error:P}=await x.from("products").select("id, stock_quantity").eq("id",r.product_id).single();if(P)throw P;const R=Number(u.stock_quantity||0),L=Math.max(0,R-r.quantity),{error:$}=await x.from("products").update({stock_quantity:L,updated_at:new Date().toISOString()}).eq("id",r.product_id);if($)throw $;await x.from("inventory_logs").insert([{product_id:r.product_id,store_id:h.store_id,type:"stock_out",quantity_change:-r.quantity,previous_quantity:R,new_quantity:L,reason:"Sale transaction",reference_type:"sale",reference_id:o.id,created_by:g.id,created_at:new Date().toISOString()}])}ue("transaction:completed",{transactionId:o.id});try{await U({title:"Sale completed",message:`${o.transaction_number} • ${l(a.total)}`,type:"success",data:{transactionId:o.id,total:a.total}})}catch{}y.success("Transaction completed successfully!"),A(),j(!1),q(""),w("cash")}catch(s){console.error("Checkout error:",s),y.error("Transaction failed. Please try again.")}finally{T(!1)}},ce=i==="cash"&&c?Math.max(0,parseFloat(c)-a.total):0;return e.jsxs("div",{className:"h-full flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100",children:"Point of Sale"}),e.jsx("div",{className:"mt-4 sm:mt-0",children:e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-300",children:[M.length," products available"]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search products by name, SKU, or barcode...",value:f,onChange:t=>V(t.target.value),className:"input pl-10"})]}),e.jsx("select",{value:k,onChange:t=>B(t.target.value),className:"input w-full sm:w-auto",children:ae.map(t=>e.jsx("option",{value:t,children:t==="all"?"All Categories":t},t))})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:Z?e.jsx("div",{className:"col-span-full py-12",children:e.jsx(O,{})}):I?e.jsx("div",{className:"col-span-full text-center text-red-600 dark:text-red-400 py-6",children:I}):M.map(t=>e.jsxs("div",{className:"card p-4 hover:shadow-md transition-shadow cursor-pointer",children:[e.jsx("div",{className:"aspect-square bg-gray-100 dark:bg-gray-700 rounded-lg mb-3 flex items-center justify-center",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx("div",{className:"text-gray-400 dark:text-gray-500 text-4xl",children:"📦"})}),e.jsx("h3",{className:"font-medium text-gray-900 dark:text-gray-100 mb-1 line-clamp-2",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-2",children:["SKU: ",t.sku]}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-bold text-primary-600",children:l(t.selling_price)}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[t.stock_quantity," in stock"]})]}),e.jsxs("button",{onClick:()=>H(t,1),className:"btn btn-primary btn-sm w-full",disabled:t.stock_quantity===0,children:[e.jsx(K,{className:"w-4 h-4 mr-1"}),"Add to Cart"]})]},t.id))}),M.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 dark:text-gray-500 text-6xl mb-4",children:"🔍"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No products found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Try adjusting your search or filters"})]})]}),e.jsx("div",{className:"lg:w-80 xl:w-96",children:e.jsxs("div",{className:"card h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center",children:[e.jsx(z,{className:"w-5 h-5 mr-2"}),"Cart (",a.itemCount,")"]}),d.items.length>0&&e.jsx("button",{onClick:()=>_(!0),className:"text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(Q,{className:"w-5 h-5"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:d.items.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(z,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Your cart is empty"}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:"Add products to get started"})]}):e.jsx("div",{className:"space-y-3",children:d.items.map(t=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-xl",children:"📦"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-gray-100 truncate",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[l(t.price)," each"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>E(t.product_id,t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors",children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsx("span",{className:"w-8 text-center font-medium",children:t.quantity}),e.jsx("button",{onClick:()=>E(t.product_id,t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors",children:e.jsx(K,{className:"w-3 h-3"})})]}),e.jsx("button",{onClick:()=>b(t.product_id),className:"text-gray-400 dark:text-gray-500 hover:text-red-500 transition-colors",children:e.jsx(Q,{className:"w-4 h-4"})})]},t.product_id))})}),d.items.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:l(a.subtotal)})]}),a.discount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600 dark:text-green-400",children:[e.jsxs("span",{children:["Discount (",a.discount,"%):"]}),e.jsxs("span",{children:["-",l(a.discountAmount)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Tax (",a.taxRate,"%):"]}),e.jsx("span",{children:l(a.taxAmount)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t dark:border-gray-700 pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:l(a.total)})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>j(!0),className:"btn btn-primary btn-lg w-full",children:[e.jsx(fe,{className:"w-5 h-5 mr-2"}),"Checkout"]})})]})]})}),e.jsx(xe,{isOpen:X,onClose:()=>j(!1),title:"Complete Transaction",size:"md",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3",children:"Order Summary"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:l(a.subtotal)})]}),a.discount>0&&e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Discount:"}),e.jsxs("span",{children:["-",l(a.discountAmount)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax:"}),e.jsx("span",{children:l(a.taxAmount)})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg border-t dark:border-gray-600 pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:l(a.total)})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Payment Method"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>w("cash"),className:`p-3 rounded-lg border-2 flex items-center justify-center space-x-2 transition-colors ${i==="cash"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{children:"Cash"})]}),e.jsxs("button",{onClick:()=>w("card"),className:`p-3 rounded-lg border-2 flex items-center justify-center space-x-2 transition-colors ${i==="card"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(ye,{className:"w-5 h-5"}),e.jsx("span",{children:"Card"})]})]})]}),i==="cash"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Amount Received"}),e.jsx("input",{type:"number",step:"0.01",value:c,onChange:t=>q(t.target.value),className:"input",placeholder:"0.00",autoFocus:!0})]}),c&&parseFloat(c)>=a.total&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-green-800 dark:text-green-400",children:"Change Due:"}),e.jsx("span",{className:"text-xl font-bold text-green-800 dark:text-green-400",children:l(ce)})]})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>j(!1),className:"btn btn-secondary btn-md flex-1",disabled:C,children:"Cancel"}),e.jsx("button",{onClick:le,disabled:C||i==="cash"&&(!c||parseFloat(c)<a.total),className:"btn btn-primary btn-md flex-1",children:C?e.jsxs(e.Fragment,{children:[e.jsx(O,{size:"sm"}),e.jsx("span",{className:"ml-2",children:"Processing..."})]}):"Complete Sale"})]})]})}),e.jsx(Y,{isOpen:G,onCancel:()=>_(!1),onConfirm:()=>{A(),_(!1)},title:"Clear cart?",description:"This will remove all items from the cart. You can't undo this action.",confirmText:"Clear",variant:"danger"}),e.jsx(Y,{isOpen:S!=null,onCancel:()=>b(null),onConfirm:()=>{S!=null&&W(S),b(null)},title:"Remove item?",description:"This item will be removed from the cart.",confirmText:"Remove",variant:"danger"})]})};export{_e as default};
//# sourceMappingURL=Sales-CgtZONNc.js.map

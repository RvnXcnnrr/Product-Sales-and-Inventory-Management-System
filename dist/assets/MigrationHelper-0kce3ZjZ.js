import{r as i,j as e,k as j,L,m as c}from"./index-Ck3Yh7nW.js";import{e as D}from"./store-user-helpers-N5knuo_n.js";const I=()=>{const[u,x]=i.useState(!1),[N,a]=i.useState(""),[p,v]=i.useState(""),[g,b]=i.useState(!1),[$,M]=i.useState(0),[E,C]=i.useState(0),[F,_]=i.useState(0),[y,U]=i.useState([]),t=(r,n="info")=>{U(l=>[...l,{message:r,type:n,timestamp:new Date}])},A=async()=>{try{x(!0),a("Starting migration..."),t("Starting migration process"),a("Fetching users...");const{data:r,error:n}=await c.from("profiles").select("id, email, full_name, role, store_id");if(n)throw new Error(`Failed to fetch profiles: ${n.message}`);t(`Found ${r.length} user profiles`),M(r.length),a("Fetching stores...");const{data:l,error:w}=await c.from("stores").select("id, name");if(w)throw new Error(`Failed to fetch stores: ${w.message}`);t(`Found ${l.length} stores`),C(l.length),a("Checking existing store user mappings...");const{data:h,error:S}=await c.from("store_users").select("store_id, user_id");if(S)throw new Error(`Failed to fetch store_users: ${S.message}`);t(`Found ${h.length} existing store user mappings`),_(h.length);const m=r.filter(s=>!h.some(o=>o.user_id===s.id));if(m.length===0){t("All users already have store mappings","success"),a("No migration needed"),b(!0);return}t(`Found ${m.length} users that need store mappings`),a(`Adding ${m.length} users to stores...`);let d=l[0];if(!d){t("No stores found, creating a default store"),a("Creating default store...");const{data:s,error:o}=await c.from("stores").insert([{name:"Default Store",code:"DEF"+Math.floor(Math.random()*1e3),created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(o)throw new Error(`Failed to create default store: ${o.message}`);d=s,t(`Created default store: ${d.name}`,"success")}for(const s of m){let o=s.store_id;if(!o&&d&&(o=d.id,t(`Will use default store for user: ${s.email||s.id}`)),!o){t(`Skipping user ${s.email||s.id} - no store_id available`,"warning");continue}const f=await D(c,s.id,o,s.role||"staff");f.success?f.created?t(`Added user ${s.email||s.id} to store`,"success"):t(`User ${s.email||s.id} already mapped to store`,"info"):t(`Failed to add user ${s.email||s.id} to store: ${f.message}`,"error")}a("Migration completed successfully!"),b(!0),t("Migration completed successfully!","success")}catch(r){console.error("Migration failed:",r),v(r.message),a("Migration failed"),t(`Error: ${r.message}`,"error")}finally{x(!1)}};return e.jsxs("div",{className:"p-6 max-w-4xl mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Authentication & Security Migration"}),e.jsx("div",{className:"mb-6",children:e.jsx("p",{className:"mb-2",children:"This utility will ensure all users are properly added to the store_users table. This fixes the issue where users can authenticate but aren't associated with a store."})}),p&&e.jsx(j,{type:"error",title:"Migration Error",message:p,className:"mb-4"}),g&&e.jsx(j,{type:"success",title:"Migration Complete",message:"All users have been successfully mapped to stores.",className:"mb-4"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow border border-gray-200 flex-1",children:[e.jsx("h3",{className:"font-medium text-gray-700",children:"Users"}),e.jsx("p",{className:"text-2xl font-bold",children:$})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow border border-gray-200 flex-1",children:[e.jsx("h3",{className:"font-medium text-gray-700",children:"Stores"}),e.jsx("p",{className:"text-2xl font-bold",children:E})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow border border-gray-200 flex-1",children:[e.jsx("h3",{className:"font-medium text-gray-700",children:"Store Users"}),e.jsx("p",{className:"text-2xl font-bold",children:F})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("button",{onClick:A,disabled:u||g,className:"btn btn-primary",children:u?"Running Migration...":g?"Migration Complete":"Run Migration"}),u&&e.jsxs("div",{className:"mt-4 flex items-center",children:[e.jsx(L,{size:"sm"}),e.jsx("span",{className:"ml-2",children:N})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-4 py-2 border-b border-gray-200",children:e.jsx("h3",{className:"font-medium",children:"Migration Log"})}),e.jsx("div",{className:"bg-gray-900 text-gray-100 p-4 font-mono text-sm h-80 overflow-y-auto",children:y.length===0?e.jsx("div",{className:"text-gray-500",children:"No logs yet. Run the migration to see details."}):y.map((r,n)=>e.jsxs("div",{className:`mb-1 ${r.type==="error"?"text-red-400":r.type==="warning"?"text-yellow-400":r.type==="success"?"text-green-400":"text-gray-300"}`,children:[e.jsxs("span",{className:"opacity-70",children:["[",r.timestamp.toLocaleTimeString(),"]"]})," ",r.message]},n))})]})]})};export{I as default};
//# sourceMappingURL=MigrationHelper-0kce3ZjZ.js.map

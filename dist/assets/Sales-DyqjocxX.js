import{d as ce,b as ie,r as n,e as oe,j as e,L as $,f as l,S as z,M as de,C as Y,s as x,V as g}from"./index-B6zJEr8W.js";import{d as me}from"./eventBus-DPsVa6OD.js";import{S as xe,P as K}from"./search-fY1kVwVO.js";import{T as Q}from"./trash-2-CJCRK_q9.js";import{M as ue}from"./minus-DaBBy3bL.js";import{D as he}from"./dollar-sign-gWT7RPE0.js";import{C as pe}from"./credit-card-CJSDI3eM.js";/**
 * @license lucide-react v0.307.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=ce("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]),Ce=()=>{const{profile:h,user:p}=ie(),[y,U]=n.useState(""),[w,V]=n.useState("all"),[B,j]=n.useState(!1),[i,C]=n.useState("cash"),[c,q]=n.useState(""),[_,T]=n.useState(!1),[X,S]=n.useState(!1),[k,b]=n.useState(null),{cart:o,totals:s,addItem:G,updateItem:H,removeItem:J,clearCart:A}=oe(),[W,D]=n.useState(!0),[F,I]=n.useState(null),[Z,ee]=n.useState([]),[te,se]=n.useState([]),[ae,re]=n.useState(new Map);n.useEffect(()=>{let t=!0;return(async()=>{try{D(!0),I(null);const{data:d,error:m}=await x.from("products").select("id, name, sku, barcode, selling_price, stock_quantity, image_url, category_id").order("name",{ascending:!0});if(m)throw m;const{data:N,error:v}=await x.from("categories").select("id, name").order("name",{ascending:!0});if(v)throw v;if(!t)return;ee(d||[]);const f=new Map((N||[]).map(u=>[u.id,u.name]));re(f);const r=Array.from(new Set((d||[]).map(u=>f.get(u.category_id)).filter(Boolean)));se(["all",...r])}catch(d){if(!t)return;console.error("Failed to load products/categories:",d),I("Failed to load products")}finally{t&&D(!1)}})(),()=>{t=!1}},[]);const M=Z.filter(t=>{const a=t.name.toLowerCase().includes(y.toLowerCase())||t.sku.toLowerCase().includes(y.toLowerCase())||(t.barcode||"").includes(y),d=ae.get(t.category_id);return a&&(w==="all"||d===w)&&t.stock_quantity>0}),E=(t,a)=>{a<=0?b(t):H(t,{quantity:a})},ne=async()=>{var t;if(o.items.length===0){g.error("Cart is empty");return}if(i==="cash"){const a=parseFloat(c);if(!a||a<s.total){g.error("Insufficient amount received");return}}T(!0);try{if(!(h!=null&&h.store_id)||!(p!=null&&p.id)){g.error("Missing store or user context");return}const a=new Date,d=`TX-${a.getFullYear()}${(a.getMonth()+1).toString().padStart(2,"0")}${a.getDate().toString().padStart(2,"0")}-${a.getTime().toString().slice(-6)}`,{data:m,error:N}=await x.from("transactions").insert([{transaction_number:d,store_id:h.store_id,customer_name:((t=o.customer)==null?void 0:t.name)||null,subtotal:s.subtotal,discount_percentage:s.discount,discount_amount:s.discountAmount,tax_rate:s.taxRate/100,tax_amount:s.taxAmount,total_amount:s.total,payment_method:i,amount_received:i==="cash"?parseFloat(c):s.total,change_amount:i==="cash"?Math.max(0,parseFloat(c)-s.total):0,status:"completed",processed_by:p.id,processed_at:a.toISOString()}]).select().single();if(N)throw N;const v=o.items.map(r=>({transaction_id:m.id,product_id:r.product_id,product_name:r.name,product_sku:r.sku,quantity:r.quantity,unit_price:r.price,total_price:r.price*r.quantity})),{error:f}=await x.from("transaction_items").insert(v);if(f)throw f;for(const r of o.items){const{data:u,error:P}=await x.from("products").select("id, stock_quantity").eq("id",r.product_id).single();if(P)throw P;const R=Number(u.stock_quantity||0),L=Math.max(0,R-r.quantity),{error:O}=await x.from("products").update({stock_quantity:L,updated_at:new Date().toISOString()}).eq("id",r.product_id);if(O)throw O;await x.from("inventory_logs").insert([{product_id:r.product_id,store_id:h.store_id,type:"stock_out",quantity_change:-r.quantity,previous_quantity:R,new_quantity:L,reason:"Sale transaction",reference_type:"sale",reference_id:m.id,created_by:p.id,created_at:new Date().toISOString()}])}me("transaction:completed",{transactionId:m.id}),g.success("Transaction completed successfully!"),A(),j(!1),q(""),C("cash")}catch(a){console.error("Checkout error:",a),g.error("Transaction failed. Please try again.")}finally{T(!1)}},le=i==="cash"&&c?Math.max(0,parseFloat(c)-s.total):0;return e.jsxs("div",{className:"h-full flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Point of Sale"}),e.jsx("div",{className:"mt-4 sm:mt-0",children:e.jsxs("span",{className:"text-sm text-gray-500",children:[M.length," products available"]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search products by name, SKU, or barcode...",value:y,onChange:t=>U(t.target.value),className:"input pl-10"})]}),e.jsx("select",{value:w,onChange:t=>V(t.target.value),className:"input w-full sm:w-auto",children:te.map(t=>e.jsx("option",{value:t,children:t==="all"?"All Categories":t},t))})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:W?e.jsx("div",{className:"col-span-full py-12",children:e.jsx($,{})}):F?e.jsx("div",{className:"col-span-full text-center text-red-600 py-6",children:F}):M.map(t=>e.jsxs("div",{className:"card p-4 hover:shadow-md transition-shadow cursor-pointer",children:[e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx("div",{className:"text-gray-400 text-4xl",children:"ðŸ“¦"})}),e.jsx("h3",{className:"font-medium text-gray-900 mb-1 line-clamp-2",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500 mb-2",children:["SKU: ",t.sku]}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-bold text-primary-600",children:l(t.selling_price)}),e.jsxs("span",{className:"text-sm text-gray-500",children:[t.stock_quantity," in stock"]})]}),e.jsxs("button",{onClick:()=>G(t,1),className:"btn btn-primary btn-sm w-full",disabled:t.stock_quantity===0,children:[e.jsx(K,{className:"w-4 h-4 mr-1"}),"Add to Cart"]})]},t.id))}),M.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 text-6xl mb-4",children:"ðŸ”"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No products found"}),e.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or filters"})]})]}),e.jsx("div",{className:"lg:w-80 xl:w-96",children:e.jsxs("div",{className:"card h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[e.jsx(z,{className:"w-5 h-5 mr-2"}),"Cart (",s.itemCount,")"]}),o.items.length>0&&e.jsx("button",{onClick:()=>S(!0),className:"text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(Q,{className:"w-5 h-5"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:o.items.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(z,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Your cart is empty"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Add products to get started"})]}):e.jsx("div",{className:"space-y-3",children:o.items.map(t=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-xl",children:"ðŸ“¦"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-gray-900 truncate",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[l(t.price)," each"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>E(t.product_id,t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(ue,{className:"w-3 h-3"})}),e.jsx("span",{className:"w-8 text-center font-medium",children:t.quantity}),e.jsx("button",{onClick:()=>E(t.product_id,t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors",children:e.jsx(K,{className:"w-3 h-3"})})]}),e.jsx("button",{onClick:()=>b(t.product_id),className:"text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(Q,{className:"w-4 h-4"})})]},t.product_id))})}),o.items.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t border-gray-200 p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:l(s.subtotal)})]}),s.discount>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{children:["Discount (",s.discount,"%):"]}),e.jsxs("span",{children:["-",l(s.discountAmount)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Tax (",s.taxRate,"%):"]}),e.jsx("span",{children:l(s.taxAmount)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:l(s.total)})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>j(!0),className:"btn btn-primary btn-lg w-full",children:[e.jsx(fe,{className:"w-5 h-5 mr-2"}),"Checkout"]})})]})]})}),e.jsx(de,{isOpen:B,onClose:()=>j(!1),title:"Complete Transaction",size:"md",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Order Summary"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:l(s.subtotal)})]}),s.discount>0&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{children:"Discount:"}),e.jsxs("span",{children:["-",l(s.discountAmount)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax:"}),e.jsx("span",{children:l(s.taxAmount)})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg border-t pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:l(s.total)})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Payment Method"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>C("cash"),className:`p-3 rounded-lg border-2 flex items-center justify-center space-x-2 transition-colors ${i==="cash"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(he,{className:"w-5 h-5"}),e.jsx("span",{children:"Cash"})]}),e.jsxs("button",{onClick:()=>C("card"),className:`p-3 rounded-lg border-2 flex items-center justify-center space-x-2 transition-colors ${i==="card"?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{children:"Card"})]})]})]}),i==="cash"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Amount Received"}),e.jsx("input",{type:"number",step:"0.01",value:c,onChange:t=>q(t.target.value),className:"input",placeholder:"0.00",autoFocus:!0})]}),c&&parseFloat(c)>=s.total&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-green-800",children:"Change Due:"}),e.jsx("span",{className:"text-xl font-bold text-green-800",children:l(le)})]})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>j(!1),className:"btn btn-secondary btn-md flex-1",disabled:_,children:"Cancel"}),e.jsx("button",{onClick:ne,disabled:_||i==="cash"&&(!c||parseFloat(c)<s.total),className:"btn btn-primary btn-md flex-1",children:_?e.jsxs(e.Fragment,{children:[e.jsx($,{size:"sm"}),e.jsx("span",{className:"ml-2",children:"Processing..."})]}):"Complete Sale"})]})]})}),e.jsx(Y,{isOpen:X,onCancel:()=>S(!1),onConfirm:()=>{A(),S(!1)},title:"Clear cart?",description:"This will remove all items from the cart. You can't undo this action.",confirmText:"Clear",variant:"danger"}),e.jsx(Y,{isOpen:k!=null,onCancel:()=>b(null),onConfirm:()=>{k!=null&&J(k),b(null)},title:"Remove item?",description:"This item will be removed from the cart.",confirmText:"Remove",variant:"danger"})]})};export{Ce as default};
//# sourceMappingURL=Sales-DyqjocxX.js.map

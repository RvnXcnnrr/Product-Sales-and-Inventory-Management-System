import{r as g,b as ne,c as oe,j as e,P as M,f as _,E as de,M as A,C as me,s as j,X as ue,V as m}from"./index-B6zJEr8W.js";import{o as xe}from"./eventBus-DPsVa6OD.js";import{c as B}from"./store-user-helpers-N5knuo_n.js";import{P as G,S as he}from"./search-fY1kVwVO.js";import{P as ge}from"./pen-square-DpWwLG_E.js";import{T as je}from"./trash-2-CJCRK_q9.js";import{S as pe}from"./save-XKjuRcBT.js";const Se=()=>{const[v,Q]=g.useState(""),[P,Y]=g.useState("all"),[X,w]=g.useState(!1),[N,S]=g.useState(null),[n,L]=g.useState(null),[k,I]=g.useState(null),{profile:t,loading:U}=ne(),[C,b]=g.useState([]),[V,q]=g.useState(!0),[E,T]=g.useState(null),[Z,K]=g.useState(["all"]),[D,z]=g.useState(new Map),[H,F]=g.useState([]);g.useEffect(()=>{let s=!0;const a=async()=>{try{if(q(!0),T(null),!(t!=null&&t.store_id)){s&&(b([]),K(["all"]),F([]));return}const{data:x,error:r}=await j.from("products").select("id, name, sku, barcode, description, cost_price, selling_price, stock_quantity, min_stock_level, image_url, category_id, created_at, updated_at").eq("store_id",t.store_id).order("updated_at",{ascending:!1});if(r)throw r;const{data:d,error:o}=await j.from("categories").select("id, name").eq("store_id",t.store_id).order("name");if(o)throw o;if(!s)return;b(x||[]);const h=new Map((d||[]).map(l=>[l.id,l.name]));z(h),F(d||[]),K(["all",...Array.from(new Set((x||[]).map(l=>h.get(l.category_id)).filter(Boolean)))])}catch(x){if(!s)return;console.error("Failed to load products:",x),T("Failed to load products")}finally{s&&q(!1)}};U?q(!0):a();const i=xe("transaction:completed",()=>a());return()=>{s=!1,i&&i()}},[U,t==null?void 0:t.store_id]);const{register:p,handleSubmit:J,reset:y,watch:O,setValue:W,getValues:ee,formState:{errors:u}}=oe(),se=(s="")=>{const a=(s||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]+/g,"").slice(0,6)||"SKU",i=Date.now().toString(36).toUpperCase().slice(-5);return`${a}-${i}`},te=async()=>{var s,a,i,x;try{let r=(t==null?void 0:t.store_id)||null;if(!r&&(t!=null&&t.id)){const{data:l,error:c}=await j.from("store_users").select("store_id").eq("user_id",t.id).eq("is_active",!0).limit(1).maybeSingle();if(c&&c.code!=="PGRST116")throw c;l!=null&&l.store_id&&(r=l.store_id)}if(!r){if(!(t!=null&&t.id)){m.error("You must be signed in");return}const l=(t.full_name||t.email||"My Store").toString().split("@")[0]+"'s Store",c=await B(j,t.id,l,"owner");if(!c.success||!c.storeId){console.error("Auto-create store failed:",c.error||c.message),m.error("Could not create a store for your account");return}r=c.storeId}const d=window.prompt("Enter new category name");if(!d||!d.trim())return;const{data:o,error:h}=await j.from("categories").insert([{name:d.trim(),store_id:r}]).select().single();if(h)throw h;F(l=>[...l,o]),z(l=>new Map(l).set(o.id,o.name)),W("category_id",o.id),m.success("Category added")}catch(r){console.error("Failed to add category:",r),(r==null?void 0:r.code)==="42501"||(a=(s=r==null?void 0:r.message)==null?void 0:s.toLowerCase)!=null&&a.call(s).includes("permission")||(x=(i=r==null?void 0:r.message)==null?void 0:i.toLowerCase)!=null&&x.call(i).includes("policy")?m.error("You do not have permission to add categories"):m.error("Failed to add category")}},R=C.filter(s=>{const a=s.name.toLowerCase().includes(v.toLowerCase())||s.sku.toLowerCase().includes(v.toLowerCase())||(s.barcode||"").includes(v),i=D.get(s.category_id);return a&&(P==="all"||i===P)}),ae=async s=>{try{let a=(t==null?void 0:t.store_id)||null;if(!a&&(t!=null&&t.id)){const{data:c,error:f}=await j.from("store_users").select("store_id").eq("user_id",t.id).eq("is_active",!0).limit(1).maybeSingle();if(f&&f.code!=="PGRST116")throw f;c!=null&&c.store_id&&(a=c.store_id)}if(!a){if(!(t!=null&&t.id)){m.error("You must be signed in");return}const c=(t.full_name||t.email||"My Store").toString().split("@")[0]+"'s Store",f=await B(j,t.id,c,"owner");if(!f.success||!f.storeId){console.error("Auto-create store failed:",f.error||f.message),m.error("Could not create a store for your account");return}a=f.storeId}let i=(s.sku||"").trim();i||(i=se(s.name));const{data:x,error:r}=await j.from("products").select("id").eq("store_id",a).eq("sku",i).maybeSingle();if(r&&r.code!=="PGRST116")throw r;if(x){m.error("SKU already exists in your store");return}const d={...s,sku:i,cost_price:parseFloat(s.cost_price),selling_price:parseFloat(s.selling_price),stock_quantity:parseInt(s.stock_quantity),min_stock_level:parseInt(s.min_stock_level),store_id:a},{data:o,error:h}=await j.from("products").insert([d]).select();if(h){if(h.code==="23505"){m.error("SKU already exists");return}throw h}const l=o==null?void 0:o[0];if(l&&d.stock_quantity>0)try{await j.from("inventory_logs").insert([{product_id:l.id,store_id:a,type:"stock_in",quantity_change:d.stock_quantity,previous_quantity:0,new_quantity:d.stock_quantity,reason:"initial_stock",notes:"Initial stock on product creation",created_by:t.id}])}catch(c){console.warn("Inventory log failed:",c)}b([...o||[],...C]),w(!1),y(),m.success("Product added successfully!")}catch(a){console.error(a),m.error("Failed to add product")}},re=async s=>{try{const a=(s.sku||"").trim()||N.sku,i={...s,sku:a,cost_price:parseFloat(s.cost_price),selling_price:parseFloat(s.selling_price),stock_quantity:parseInt(s.stock_quantity),min_stock_level:parseInt(s.min_stock_level)},{data:x,error:r}=await j.from("products").update(i).eq("id",N.id).select();if(r)throw r;const d=C.map(o=>o.id===N.id?x[0]:o);b(d),S(null),y(),m.success("Product updated successfully!")}catch(a){console.error(a),m.error("Failed to update product")}},le=s=>{I(s)},ie=()=>{k!=null&&j.from("products").delete().eq("id",k).then(({error:s})=>{s?(console.error(s),m.error("Failed to delete product")):(b(C.filter(a=>a.id!==k)),m.success("Product deleted successfully!"))})},ce=s=>s.stock_quantity===0?{status:"out",color:"text-red-600",bg:"bg-red-100"}:s.stock_quantity<=s.min_stock_level?{status:"low",color:"text-orange-600",bg:"bg-orange-100"}:{status:"good",color:"text-green-600",bg:"bg-green-100"},$=({product:s,onSubmit:a,onCancel:i})=>{const x=parseFloat(O("cost_price")||0),r=parseFloat(O("selling_price")||0),d=Math.max(r-x,0),o=r>0?d/r*100:0,h=!!s;return e.jsxs("form",{onSubmit:J(a),className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Product Name *"}),e.jsx("input",{...p("name",{required:"Product name is required"}),className:"input",defaultValue:s==null?void 0:s.name,placeholder:"Enter product name"}),u.name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.name.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:["SKU ",h?"*":""]}),e.jsx("input",{...p("sku"),className:"input",defaultValue:s==null?void 0:s.sku,placeholder:h?"Enter SKU":"Leave blank to auto-generate"}),u.sku&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.sku.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Barcode"}),e.jsx("input",{...p("barcode"),className:"input",defaultValue:s==null?void 0:s.barcode,placeholder:"Enter barcode"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"label",children:"Category *"}),e.jsxs("button",{type:"button",onClick:te,className:"text-sm text-primary-600 hover:text-primary-500 inline-flex items-center",children:[e.jsx(G,{className:"w-3 h-3 mr-1"})," Add new"]})]}),e.jsxs("select",{...p("category_id",{required:"Category is required"}),className:"input",defaultValue:(s==null?void 0:s.category_id)||"",children:[e.jsx("option",{value:"",children:"Select category"}),H.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),u.category_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.category_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Cost Price *"}),e.jsx("input",{type:"number",step:"0.01",...p("cost_price",{required:"Cost price is required",min:{value:0,message:"Cost price must be positive"}}),className:"input",defaultValue:s==null?void 0:s.cost_price,placeholder:"0.00"}),u.cost_price&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.cost_price.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Selling Price *"}),e.jsx("input",{type:"number",step:"0.01",...p("selling_price",{required:"Selling price is required",min:{value:0,message:"Selling price must be positive"},validate:l=>parseFloat(l||0)>=parseFloat(ee("cost_price")||0)||"Selling must be greater than or equal to cost"}),className:"input",defaultValue:s==null?void 0:s.selling_price,placeholder:"0.00"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Margin: ",_(d)," (",o.toFixed(1),"%)"]}),u.selling_price&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.selling_price.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Stock Quantity *"}),e.jsx("input",{type:"number",...p("stock_quantity",{required:"Stock quantity is required",min:{value:0,message:"Stock quantity must be positive"}}),className:"input",defaultValue:s==null?void 0:s.stock_quantity,placeholder:"0"}),u.stock_quantity&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.stock_quantity.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Minimum Stock Level"}),e.jsx("input",{type:"number",...p("min_stock_level",{min:{value:0,message:"Minimum stock must be positive"}}),className:"input",defaultValue:(s==null?void 0:s.min_stock_level)||0,placeholder:"0"}),u.min_stock_level&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.min_stock_level.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{...p("description"),className:"input h-24 resize-none",defaultValue:s==null?void 0:s.description,placeholder:"Enter product description"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e.jsxs("button",{type:"button",onClick:i,className:"btn btn-secondary btn-md",children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",className:"btn btn-primary btn-md",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),h?"Update Product":"Add Product"]})]})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Products"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Manage your product catalog and inventory"})]}),e.jsxs("button",{onClick:()=>w(!0),className:"btn btn-primary btn-md mt-4 sm:mt-0",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Add Product"]})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search products by name, SKU, or barcode...",value:v,onChange:s=>Q(s.target.value),className:"input pl-10"})]}),e.jsx("select",{value:P,onChange:s=>Y(s.target.value),className:"input w-full sm:w-auto",children:Z.map(s=>e.jsx("option",{value:s,children:s==="all"?"All Categories":s},s))})]})}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"table-header",children:e.jsxs("tr",{children:[e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Product"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"SKU"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Category"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Price"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Stock"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"table-cell text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:V?e.jsx("tr",{children:e.jsx("td",{className:"table-cell p-6",colSpan:"7",children:"Loading..."})}):E?e.jsx("tr",{children:e.jsx("td",{className:"table-cell p-6 text-red-600",colSpan:"7",children:E})}):R.map(s=>{const a=ce(s);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3",children:s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx(M,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500 truncate max-w-xs",children:s.description})]})]})}),e.jsx("td",{className:"table-cell",children:e.jsx("div",{className:"text-sm font-mono",children:s.sku})}),e.jsx("td",{className:"table-cell",children:e.jsx("span",{className:"badge badge-info",children:D.get(s.category_id)||"Uncategorized"})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:_(s.selling_price)}),e.jsxs("div",{className:"text-gray-500",children:["Cost: ",_(s.cost_price)]})]})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:s.stock_quantity}),e.jsxs("div",{className:"text-gray-500",children:["Min: ",s.min_stock_level]})]})}),e.jsx("td",{className:"table-cell",children:e.jsx("span",{className:`badge ${a.bg} ${a.color}`,children:a.status==="out"?"Out of Stock":a.status==="low"?"Low Stock":"In Stock"})}),e.jsx("td",{className:"table-cell",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>L(s),className:"text-gray-400 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{S(s),y(s)},className:"text-gray-400 hover:text-green-600 transition-colors",title:"Edit Product",children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>le(s.id),className:"text-gray-400 hover:text-red-600 transition-colors",title:"Delete Product",children:e.jsx(je,{className:"w-4 h-4"})})]})})]},s.id)})})]})}),R.length===0&&!V&&!E&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(M,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No products found"}),e.jsx("p",{className:"text-gray-500",children:"Try adjusting your search or add a new product"})]})]}),e.jsx(A,{isOpen:X,onClose:()=>{w(!1),y()},title:"Add New Product",size:"lg",children:e.jsx($,{onSubmit:ae,onCancel:()=>{w(!1),y()}})}),e.jsx(A,{isOpen:!!N,onClose:()=>{S(null),y()},title:"Edit Product",size:"lg",children:e.jsx($,{product:N,onSubmit:re,onCancel:()=>{S(null),y()}})}),e.jsx(A,{isOpen:!!n,onClose:()=>L(null),title:"Product Details",size:"md",children:n&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center",children:n.image_url?e.jsx("img",{src:n.image_url,alt:n.name,className:"w-full h-full object-cover rounded-lg"}):e.jsx(M,{className:"w-8 h-8 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:n.name}),e.jsx("p",{className:"text-gray-500",children:D.get(n.category_id)||"Uncategorized"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"SKU"}),e.jsx("p",{className:"font-mono",children:n.sku})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Barcode"}),e.jsx("p",{className:"font-mono",children:n.barcode||"N/A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Cost Price"}),e.jsx("p",{children:_(n.cost_price)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Selling Price"}),e.jsx("p",{className:"font-semibold",children:_(n.selling_price)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Stock Quantity"}),e.jsx("p",{children:n.stock_quantity})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Min Stock Level"}),e.jsx("p",{children:n.min_stock_level})]})]}),n.description&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-500",children:"Description"}),e.jsx("p",{className:"text-gray-900",children:n.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-500",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-medium",children:"Created"}),e.jsx("p",{children:new Date(n.created_at).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-medium",children:"Last Updated"}),e.jsx("p",{children:new Date(n.updated_at).toLocaleDateString()})]})]})]})}),e.jsx(me,{isOpen:k!=null,onCancel:()=>I(null),onConfirm:ie,title:"Delete product?",description:"This action cannot be undone. The product will be removed from your catalog.",confirmText:"Delete",variant:"danger"})]})};export{Se as default};
//# sourceMappingURL=Products-JBUUiMH9.js.map
